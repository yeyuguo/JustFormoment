<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>我的订单</title>
    <script type="text/jscript">
    document.write('<link rel="stylesheet" href="css/jquery.mobile-1.4.2.min.css">');
    document.write('<link rel="stylesheet" href="css/MyOrder.css">');
    </script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.mobile-1.4.2.min.js"></script>
    <script src="js/mian.js"></script>
    <style type="text/css" media="all">
    </style>
    <script type="text/javascript" language="javascript">
    var OrderList;
	var NeedPayOrderList = new Array();
	var SendOrderList= new Array();
	var NeedAcceptOrderList= new Array();
	var tabID;
	 $(document).on("pageinit","#JQM_OrderList",function(){
		 tabID = GetQueryString("order_class_id");
		 //alert(tabID);
		 var this_table = document.getElementById("tb_"+tabID);
		 this_table.className="on";
	 });
    $(document).on("pageshow","#JQM_OrderList",function(){
	 $("#OrderList").find("li").remove(); //清空列表
		$.mobile.loading('show',{text:"请稍后...",textVisible:true,theme:"b"});
		//alert(localStorage.getItem("H_URL")+"yxtws/v1/hxyxt/orders");
		$.ajax({
			url:localStorage.getItem("H_URL")+"yxtws/v1/hxyxt/orders",
			type:"GET",
			data:{access_token:localStorage.getItem("access_token")},
			dataType:"json",
			contentType:"application/x-www-form-urlencoded; charset=utf-8",
			success:function(data){
				$.mobile.loading("hide");
				//alert(JSON.stringify(data));
				if(data.orders.length>0){
					for(var i=0;i<data.orders.length;i++){
			         	var order_state;
			        	var order_price = data.orders[i].total.formattedValue;
				        var order_time = data.orders[i].placed;
				        var date_time = order_time.substr(0, 10) +" "+ order_time.substr(11, 8);
				        if(data.orders[i].statusDisplay == "processing"){
					           order_state = "处理中";
				        }
						var map_state = data.orders[i].status;
						var order_state;
						if(map_state == null || map_state == ""){
							order_state = data.orders[i].statusDisplay;
						}else{
							order_state = data.orders[i].status.code;
						}
						
						//alert(order_state);
						if(order_state == "created"){
							var j = NeedPayOrderList.length;
							NeedPayOrderList[j]=data.orders[i];
						
						}
						if(order_state == "PICKING"){
							var j = SendOrderList.length;
							SendOrderList[j]=data.orders[i];
						}
						if(order_state == "SHIPPED"){
							//alert("shipped");
							var j = NeedAcceptOrderList.length;
							//alert(j);
							NeedAcceptOrderList[j]=data.orders[i];
						}
                     
				     
					 
				}
					OrderList = data;  //赋值
					OnclickClass(tabID);
		
				}
				
			},
			error:function(msg){
				//alert(JSON.stringify(msg));
				$.mobile.loading("hide");
				//window.location="Login.html";
				//window.location.load();	
			}
		});
});

       //跳转到对应的详情页
		function SelectOrder(i){
		 // alert("进入跳转"+JSON.stringify(OrderList.orders[i]));
		 
		  localStorage.setItem("OrderObj",JSON.stringify(OrderList.orders[i]));
		  window.location="MyOrderDetails.html";
		  window.location.load();	
	   }
    
		 //点击类别
		function OnclickClass(i){
			var RefreshOrderList;
			if(i == 1){
				RefreshOrderList = OrderList.orders;
			}else if(i == 2){
				RefreshOrderList = NeedPayOrderList;
			}
			else if(i == 3){
				RefreshOrderList = SendOrderList;
			}
			else if(i ==4){
				RefreshOrderList = NeedAcceptOrderList;
			}
			if(RefreshOrderList.length>0){
				$("#OrderList").find("li").remove(); //清空列表
				for(var i=0;i<RefreshOrderList.length;i++){
			         	var order_state;
			        	var order_price = RefreshOrderList[i].total.formattedValue;
				        var order_time = RefreshOrderList[i].placed;
				        var date_time = order_time.substr(0, 10) +" "+ order_time.substr(11, 8);
				        if(RefreshOrderList[i].statusDisplay == "processing"){
					           order_state = "处理中";
				        }
						
                       var liItem ='<li> <div class="ListItem"> <a href="#" rel="external" onClick=SelectOrder('+i+')>' +
                      ' <div class="Order_info">'+
                      ' <div class="TotalPrice" id="eamilID"><span>订单号：'+RefreshOrderList[i].code+'</span></div>'+
                      ' <div class="OrderState" id="sexID"><span>订单状态：'+order_state+'</span></div>'+
                      ' <div class="OrderTime" id="tellID"><span>下单时间：'+date_time+'</span></div>'+
                      ' <div class="OrderNumber" id="birthdayID"><span>总价：'+order_price+'</span></div>'+
                      ' </div> </a></div></li> ';
				     
					
					  $("#OrderList").append(liItem);  //添加到ul中
				}
				$("#OrderList").listview('refresh');
			}else{
				
			}
		}
</script>
</head>

<body>
    <div data-role="page" id="JQM_OrderList" class="wj-obl">
        <div data-role="header" data-position="fixed" class="wj-top">
            <div class="wj-topImg1 fl">
                <a href="#" data-rel="back">
                    <img src="image/button-48.png">
                </a>
            </div>
            <div class="wj-topTxt fl">
                <span>我的订单</span>
            </div>
            <div class="wj-topImg2 fr">
                <a href="#">
                    <img src="image/button-42.png">
                </a>
            </div>
        </div>

        <div data-role="content" id="wj-con" class="department">
            <div class="wj-conTit">
                <ul>
                    <li id="tb_1">
                        <a href="#" onClick=OnclickClass(1)>全部</a>
                    </li>
                    <li id="tb_2">
                        <a href="#" onClick=OnclickClass(2)>待付款</a>
                    </li>
                    <li id="tb_3">
                        <a href="#" onClick=OnclickClass(3)>待发货</a>
                    </li>
                    <li id="tb_4">
                        <a href="#" onClick=OnclickClass(4)>待收货</a>
                    </li>
                </ul>
            </div>
            <div class="divstyle">
              <!-- 全部 -->
                <div class="department_c dis" id="tbc_11">
                     <ul data-role="listview" id="OrderList" >
                             <li>
                                    
                             </li>  
                     </ul>
                  
                    
                </div>
          

            </div>
        </div>
    </div>
    <script>
    function tab(e) {
        var elm = $(e),
            tabs = elm.find('ul li'),
            tabc = elm.find('.department_c');
        tabs.each(function(i) {
            $(tabs[i]).on('click', function() {
                tabs.each(function() {
                    tabs.hasClass('on') ? tabs.removeClass('on') : false;
                }) 
                $(tabs[i]).addClass('on');
            })
        })
    }
    tab('#wj-con')
    </script>
</body>

</html>
